<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>AI Meeting Assistant</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function MeetingAssistant() {
            const [meetings, setMeetings] = useState([]);
            const [isProcessing, setIsProcessing] = useState(false);
            const [processingStatus, setProcessingStatus] = useState('');
            const [selectedMeeting, setSelectedMeeting] = useState(null);
            const [apiKeys, setApiKeys] = useState({ openai: '', anthropic: '' });
            const [showSettings, setShowSettings] = useState(false);
            const [isRecording, setIsRecording] = useState(false);
            const [recordingTime, setRecordingTime] = useState(0);
            
            const fileInputRef = useRef(null);
            const mediaRecorderRef = useRef(null);
            const chunksRef = useRef([]);
            const timerRef = useRef(null);
            const streamRef = useRef(null);

            useEffect(() => {
                // Load data from localStorage
                const savedMeetings = localStorage.getItem('ai-meetings');
                const savedKeys = localStorage.getItem('api-keys');
                
                if (savedMeetings) {
                    try {
                        setMeetings(JSON.parse(savedMeetings));
                    } catch (e) {
                        console.error('Error loading meetings:', e);
                    }
                }
                
                if (savedKeys) {
                    try {
                        setApiKeys(JSON.parse(savedKeys));
                    } catch (e) {
                        console.error('Error loading API keys:', e);
                    }
                }

                return () => {
                    if (timerRef.current) clearInterval(timerRef.current);
                    if (streamRef.current) {
                        streamRef.current.getTracks().forEach(track => track.stop());
                    }
                };
            }, []);

            useEffect(() => {
                localStorage.setItem('ai-meetings', JSON.stringify(meetings));
            }, [meetings]);

            useEffect(() => {
                localStorage.setItem('api-keys', JSON.stringify(apiKeys));
            }, [apiKeys]);

            const startRecording = async () => {
                if (!apiKeys.openai || !apiKeys.anthropic) {
                    alert('Please set your API keys in Settings first!');
                    setShowSettings(true);
                    return;
                }

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            sampleRate: 44100
                        } 
                    });
                    
                    streamRef.current = stream;
                    
                    const mimeType = MediaRecorder.isTypeSupported('audio/mp4') 
                        ? 'audio/mp4' 
                        : MediaRecorder.isTypeSupported('audio/webm') 
                        ? 'audio/webm'
                        : 'audio/ogg';
                    
                    mediaRecorderRef.current = new MediaRecorder(stream, { mimeType });
                    chunksRef.current = [];

                    mediaRecorderRef.current.ondataavailable = (e) => {
                        if (e.data.size > 0) {
                            chunksRef.current.push(e.data);
                        }
                    };

                    mediaRecorderRef.current.start(1000);
                    setIsRecording(true);
                    setRecordingTime(0);

                    timerRef.current = setInterval(() => {
                        setRecordingTime(prev => prev + 1);
                    }, 1000);
                } catch (error) {
                    alert('Error accessing microphone: ' + error.message);
                }
            };

            const stopRecording = () => {
                if (mediaRecorderRef.current && isRecording) {
                    mediaRecorderRef.current.stop();
                    clearInterval(timerRef.current);

                    mediaRecorderRef.current.onstop = async () => {
                        const audioBlob = new Blob(chunksRef.current, { 
                            type: mediaRecorderRef.current.mimeType 
                        });

                        setIsRecording(false);
                        setRecordingTime(0);
                        
                        // Process the recording
                        await processAudioFile(audioBlob, `Recording ${new Date().toLocaleString()}`);
                    };

                    if (streamRef.current) {
                        streamRef.current.getTracks().forEach(track => track.stop());
                    }
                }
            };

            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                if (!apiKeys.openai || !apiKeys.anthropic) {
                    alert('Please set your API keys in Settings first!');
                    setShowSettings(true);
                    return;
                }

                // Check file type
                if (!file.type.startsWith('audio/')) {
                    alert('Please upload an audio file');
                    return;
                }

                // Check file size (max 25MB for Whisper)
                if (file.size > 25 * 1024 * 1024) {
                    alert('File too large. Maximum size is 25MB. Try recording shorter segments.');
                    return;
                }

                await processAudioFile(file, file.name);
            };

            const processAudioFile = async (audioFile, fileName) => {
                setIsProcessing(true);
                setProcessingStatus('Transcribing audio with Whisper AI...');

                const meeting = {
                    id: Date.now(),
                    title: fileName.replace(/\.[^/.]+$/, ''),
                    date: new Date().toISOString(),
                    fileName: fileName,
                    fileSize: audioFile.size,
                    transcript: null,
                    speakers: null,
                    summary: null,
                    keyPoints: null,
                    actionItems: null,
                    decisions: null,
                    tags: []
                };

                setMeetings(prev => [meeting, ...prev]);

                try {
                    // Step 1: Transcribe with Whisper
                    const formData = new FormData();
                    formData.append('file', audioFile);
                    formData.append('model', 'whisper-1');
                    formData.append('response_format', 'verbose_json');
                    formData.append('timestamp_granularities[]', 'segment');

                    const transcriptResponse = await fetch('https://api.openai.com/v1/audio/transcriptions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKeys.openai}`
                        },
                        body: formData
                    });

                    if (!transcriptResponse.ok) {
                        const error = await transcriptResponse.json();
                        throw new Error(error.error?.message || 'Transcription failed');
                    }

                    const transcriptData = await transcriptResponse.json();
                    const fullTranscript = transcriptData.text;

                    meeting.transcript = fullTranscript;
                    meeting.duration = transcriptData.duration;
                    setMeetings(prev => prev.map(m => m.id === meeting.id ? meeting : m));

                    // Step 2: Detect speakers with Claude (simulated diarization)
                    setProcessingStatus('Identifying speakers...');
                    
                    const speakerResponse = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': apiKeys.anthropic,
                            'anthropic-version': '2023-06-01'
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 2000,
                            messages: [{
                                role: 'user',
                                content: `Analyze this meeting transcript and identify different speakers. Format the transcript with speaker labels (Speaker 1, Speaker 2, etc.) based on context clues, topic changes, and conversational patterns.

If it's clearly a monologue or single speaker, label everything as "Speaker 1".

Transcript:
${fullTranscript}

Respond ONLY with the formatted transcript with speaker labels like:
Speaker 1: [their dialogue]
Speaker 2: [their dialogue]
etc.`
                            }]
                        })
                    });

                    const speakerData = await speakerResponse.json();
                    const speakerTranscript = speakerData.content[0].text;
                    meeting.speakers = speakerTranscript;
                    setMeetings(prev => prev.map(m => m.id === meeting.id ? meeting : m));

                    // Step 3: Generate summary with Claude
                    setProcessingStatus('Generating AI summary...');
                    
                    const summaryResponse = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': apiKeys.anthropic,
                            'anthropic-version': '2023-06-01'
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 2000,
                            messages: [{
                                role: 'user',
                                content: `Analyze this meeting transcript and provide:
1. A concise summary (2-3 sentences)
2. Key discussion points (3-7 bullet points)
3. Action items with assignees if mentioned
4. Decisions made
5. Relevant tags/categories (e.g., "Product Planning", "Budget Review", etc.)

Transcript:
${fullTranscript}

Respond ONLY with valid JSON:
{
  "summary": "...",
  "keyPoints": ["...", "..."],
  "actionItems": ["...", "..."],
  "decisions": ["...", "..."],
  "tags": ["...", "..."]
}`
                            }]
                        })
                    });

                    const summaryData = await summaryResponse.json();
                    const summaryText = summaryData.content[0].text;
                    
                    let parsed;
                    try {
                        const jsonMatch = summaryText.match(/\{[\s\S]*\}/);
                        parsed = JSON.parse(jsonMatch ? jsonMatch[0] : summaryText);
                    } catch (e) {
                        parsed = {
                            summary: 'Unable to parse summary',
                            keyPoints: [],
                            actionItems: [],
                            decisions: [],
                            tags: []
                        };
                    }

                    meeting.summary = parsed.summary;
                    meeting.keyPoints = parsed.keyPoints || [];
                    meeting.actionItems = parsed.actionItems || [];
                    meeting.decisions = parsed.decisions || [];
                    meeting.tags = parsed.tags || [];
                    
                    setMeetings(prev => prev.map(m => m.id === meeting.id ? meeting : m));
                    setProcessingStatus('‚úì Complete!');
                    
                    setTimeout(() => {
                        setIsProcessing(false);
                        setProcessingStatus('');
                    }, 2000);

                } catch (error) {
                    console.error('Processing error:', error);
                    alert('Error processing audio: ' + error.message);
                    setIsProcessing(false);
                    setProcessingStatus('');
                    
                    // Remove failed meeting
                    setMeetings(prev => prev.filter(m => m.id !== meeting.id));
                }
            };

            const formatTime = (seconds) => {
                if (!seconds) return '0:00';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            const formatFileSize = (bytes) => {
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            };

            const exportMeeting = (meeting) => {
                const content = `${meeting.title}
${new Date(meeting.date).toLocaleString()}
${meeting.duration ? `Duration: ${formatTime(meeting.duration)}` : ''}

SUMMARY:
${meeting.summary || 'No summary available'}

KEY POINTS:
${meeting.keyPoints?.map(point => `‚Ä¢ ${point}`).join('\n') || 'None'}

ACTION ITEMS:
${meeting.actionItems?.map(item => `‚Ä¢ ${item}`).join('\n') || 'None'}

DECISIONS:
${meeting.decisions?.map(dec => `‚Ä¢ ${dec}`).join('\n') || 'None'}

TAGS: ${meeting.tags?.join(', ') || 'None'}

---

TRANSCRIPT WITH SPEAKERS:
${meeting.speakers || meeting.transcript || 'No transcript available'}
`;
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${meeting.title.replace(/[^a-z0-9]/gi, '-')}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const deleteMeeting = (id) => {
                if (confirm('Delete this meeting?')) {
                    setMeetings(prev => prev.filter(m => m.id !== id));
                    if (selectedMeeting?.id === id) setSelectedMeeting(null);
                }
            };

            const copyToClipboard = (text) => {
                navigator.clipboard.writeText(text).then(() => {
                    alert('Copied to clipboard!');
                }).catch(() => {
                    alert('Failed to copy');
                });
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-violet-50 via-white to-blue-50 pb-20">
                    <div className="max-w-4xl mx-auto p-4">
                        {/* Header */}
                        <header className="flex justify-between items-center mb-6 pt-4">
                            <div>
                                <h1 className="text-3xl font-bold text-gray-800">üéôÔ∏è AI Meeting Assistant</h1>
                                <p className="text-sm text-gray-600">Like Plaud, but free</p>
                            </div>
                            <button
                                onClick={() => setShowSettings(!showSettings)}
                                className="text-gray-600 hover:text-gray-800 text-2xl"
                            >
                                ‚öôÔ∏è
                            </button>
                        </header>

                        {/* Settings Panel */}
                        {showSettings && (
                            <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                                <h2 className="text-xl font-bold mb-4">API Settings</h2>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            OpenAI API Key (for Whisper transcription)
                                        </label>
                                        <input
                                            type="password"
                                            value={apiKeys.openai}
                                            onChange={(e) => setApiKeys({...apiKeys, openai: e.target.value})}
                                            placeholder="sk-..."
                                            className="w-full p-3 border border-gray-300 rounded-lg text-sm"
                                        />
                                        <p className="text-xs text-gray-500 mt-1">
                                            Get it from <a href="https://platform.openai.com/api-keys" target="_blank" className="text-blue-600">platform.openai.com</a>
                                        </p>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            Anthropic API Key (for Claude summaries)
                                        </label>
                                        <input
                                            type="password"
                                            value={apiKeys.anthropic}
                                            onChange={(e) => setApiKeys({...apiKeys, anthropic: e.target.value})}
                                            placeholder="sk-ant-..."
                                            className="w-full p-3 border border-gray-300 rounded-lg text-sm"
                                        />
                                        <p className="text-xs text-gray-500 mt-1">
                                            Get it from <a href="https://console.anthropic.com/" target="_blank" className="text-blue-600">console.anthropic.com</a>
                                        </p>
                                    </div>
                                    <div className="bg-blue-50 p-3 rounded-lg text-xs text-gray-700">
                                        <strong>üí∞ Cost estimate:</strong> ~$0.006/min for transcription + ~$0.01 per summary
                                        <br/>Your keys are stored locally in your browser only.
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Upload/Record Section */}
                        <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
                            {!isRecording ? (
                                <div className="space-y-4">
                                    <button
                                        onClick={startRecording}
                                        className="w-full bg-red-500 active:bg-red-600 text-white px-6 py-4 rounded-xl text-lg font-semibold shadow-lg flex items-center justify-center gap-2"
                                    >
                                        <span className="text-2xl">üéôÔ∏è</span>
                                        Record New Meeting
                                    </button>
                                    
                                    <div className="text-center text-gray-500 text-sm">or</div>
                                    
                                    <button
                                        onClick={() => fileInputRef.current?.click()}
                                        className="w-full bg-indigo-500 active:bg-indigo-600 text-white px-6 py-4 rounded-xl text-lg font-semibold shadow-lg flex items-center justify-center gap-2"
                                    >
                                        <span className="text-2xl">üìÅ</span>
                                        Upload Voice Memo
                                    </button>
                                    <input
                                        ref={fileInputRef}
                                        type="file"
                                        accept="audio/*"
                                        onChange={handleFileUpload}
                                        className="hidden"
                                    />
                                    
                                    <p className="text-xs text-gray-500 text-center mt-2">
                                        Supports: MP3, M4A, WAV, WEBM (max 25MB)
                                    </p>
                                </div>
                            ) : (
                                <div className="text-center space-y-4">
                                    <div className="text-5xl font-mono text-gray-800">
                                        {formatTime(recordingTime)}
                                    </div>
                                    <div className="flex items-center justify-center gap-2">
                                        <div className="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                                        <span className="text-red-500 font-semibold">RECORDING</span>
                                    </div>
                                    <button
                                        onClick={stopRecording}
                                        className="w-full bg-gray-700 active:bg-gray-800 text-white px-6 py-3 rounded-xl font-semibold"
                                    >
                                        ‚èπÔ∏è Stop & Process
                                    </button>
                                </div>
                            )}
                        </div>

                        {/* Processing Status */}
                        {isProcessing && (
                            <div className="bg-blue-50 border-2 border-blue-300 rounded-xl p-6 mb-6">
                                <div className="flex items-center justify-center gap-3 mb-2">
                                    <div className="animate-spin w-6 h-6 border-4 border-blue-500 border-t-transparent rounded-full"></div>
                                    <span className="text-blue-700 font-semibold">{processingStatus}</span>
                                </div>
                                <p className="text-xs text-center text-blue-600">This may take a minute...</p>
                            </div>
                        )}

                        {/* Meetings List */}
                        <div className="bg-white rounded-2xl shadow-lg p-6">
                            <h2 className="text-xl font-bold text-gray-800 mb-4">Meetings</h2>
                            
                            {meetings.length === 0 ? (
                                <div className="text-center py-12">
                                    <div className="text-6xl mb-4">üé§</div>
                                    <p className="text-gray-500">No meetings yet</p>
                                    <p className="text-sm text-gray-400 mt-2">Record or upload audio to get started</p>
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    {meetings.map(meeting => (
                                        <div key={meeting.id} className="border-2 border-gray-200 rounded-xl p-4 hover:border-indigo-300 transition">
                                            <div className="flex justify-between items-start">
                                                <div className="flex-1">
                                                    <h3 className="font-bold text-gray-800 mb-1">{meeting.title}</h3>
                                                    <div className="flex flex-wrap gap-2 text-xs text-gray-500 mb-2">
                                                        <span>üìÖ {new Date(meeting.date).toLocaleDateString()}</span>
                                                        {meeting.duration && <span>‚è±Ô∏è {formatTime(meeting.duration)}</span>}
                                                        {meeting.fileSize && <span>üíæ {formatFileSize(meeting.fileSize)}</span>}
                                                    </div>
                                                    {meeting.tags && meeting.tags.length > 0 && (
                                                        <div className="flex flex-wrap gap-1 mb-2">
                                                            {meeting.tags.map((tag, i) => (
                                                                <span key={i} className="bg-purple-100 text-purple-700 px-2 py-1 rounded text-xs">
                                                                    {tag}
                                                                </span>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                                <button
                                                    onClick={() => setSelectedMeeting(selectedMeeting?.id === meeting.id ? null : meeting)}
                                                    className="text-indigo-600 font-medium text-sm ml-3"
                                                >
                                                    {selectedMeeting?.id === meeting.id ? '‚ñ≤' : '‚ñº'}
                                                </button>
                                            </div>

                                            {selectedMeeting?.id === meeting.id && (
                                                <div className="mt-4 space-y-4 border-t-2 pt-4">
                                                    {meeting.summary && (
                                                        <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg">
                                                            <div className="flex justify-between items-start mb-2">
                                                                <h4 className="font-bold text-gray-700 text-sm">üìù Summary</h4>
                                                                <button
                                                                    onClick={() => copyToClipboard(meeting.summary)}
                                                                    className="text-xs text-indigo-600"
                                                                >
                                                                    Copy
                                                                </button>
                                                            </div>
                                                            <p className="text-sm text-gray-700">{meeting.summary}</p>
                                                        </div>
                                                    )}

                                                    {meeting.keyPoints && meeting.keyPoints.length > 0 && (
                                                        <div>
                                                            <h4 className="font-bold text-gray-700 text-sm mb-2">üîë Key Points</h4>
                                                            <ul className="space-y-2">
                                                                {meeting.keyPoints.map((point, i) => (
                                                                    <li key={i} className="text-sm text-gray-700 flex gap-2">
                                                                        <span className="text-indigo-500">‚Ä¢</span>
                                                                        <span>{point}</span>
                                                                    </li>
                                                                ))}
                                                            </ul>
                                                        </div>
                                                    )}

                                                    {meeting.actionItems && meeting.actionItems.length > 0 && (
                                                        <div>
                                                            <h4 className="font-bold text-gray-700 text-sm mb-2">‚úÖ Action Items</h4>
                                                            <ul className="space-y-2">
                                                                {meeting.actionItems.map((item, i) => (
                                                                    <li key={i} className="text-sm text-gray-700 flex gap-2">
                                                                        <span>‚òëÔ∏è</span>
                                                                        <span>{item}</span>
                                                                    </li>
                                                                ))}
                                                            </ul>
                                                        </div>
                                                    )}

                                                    {meeting.decisions && meeting.decisions.length > 0 && (
                                                        <div>
                                                            <h4 className="font-bold text-gray-700 text-sm mb-2">üí° Decisions</h4>
                                                            <ul className="space-y-2">
                                                                {meeting.decisions.map((dec, i) => (
                                                                    <li key={i} className="text-sm text-gray-700 flex gap-2">
                                                                        <span>‚úì</span>
                                                                        <span>{dec}</span>
                                                                    </li>
                                                                ))}
                                                            </ul>
                                                        </div>
                                                    )}

                                                    {meeting.speakers && (
                                                        <div>
                                                            <div className="flex justify-between items-start mb-2">
                                                                <h4 className="font-bold text-gray-700 text-sm">üë• Transcript (with speakers)</h4>
                                                                <button
                                                                    onClick={() => copyToClipboard(meeting.speakers)}
                                                                    className="text-xs text-indigo-600"
                                                                >
                                                                    Copy
                                                                </button>
                                                            </div>
                                                            <div className="bg-gray-50 p-3 rounded-lg text-xs text-gray-700 max-h-64 overflow-y-auto whitespace-pre-wrap font-mono">
                                                                {meeting.speakers}
                                                            </div>
                                                        </div>
                                                    )}

                                                    <div className="flex gap-2 pt-2">
                                                        <button
                                                            onClick={() => exportMeeting(meeting)}
                                                            className="flex-1 bg-green-500 active:bg-green-600 text-white px-4 py-3 rounded-lg font-semibold text-sm"
                                                        >
                                                            üì• Export
                                                        </button>
                                                        <button
                                                            onClick={() => deleteMeeting(meeting.id)}
                                                            className="bg-red-500 active:bg-red-600 text-white px-4 py-3 rounded-lg font-semibold text-sm"
                                                        >
                                                            üóëÔ∏è
                                                        </button>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        {/* Info Footer */}
                        <div className="mt-6 bg-gray-100 rounded-lg p-4 text-xs text-gray-600">
                            <p className="font-semibold mb-2">üí° How it works:</p>
                            <ol className="space-y-1 list-decimal list-inside">
                                <li>Record meetings or upload Voice Memos</li>
                                <li>Whisper AI transcribes with speaker detection</li>
                                <li>Claude generates summaries & action items</li>
                                <li>Export as text or copy to clipboard</li>
                            </ol>
                            <p className="mt-3 text-center">
                                <strong>No subscription. Just API costs (~$0.02 per meeting)</strong>
                            </p>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<MeetingAssistant />, document.getElementById('root'));
    </script>
</body>
</html>